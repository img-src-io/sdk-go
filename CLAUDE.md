# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Overview

This is the **img-src Go SDK** (`github.com/img-src-io/sdk-go`), auto-generated from an OpenAPI spec using [Speakeasy](https://speakeasy.com). All files marked with "Code generated by Speakeasy" will be overwritten on regeneration. Manual edits should only go in non-generated files (e.g., `internal/hooks/registration.go`).

## Commands

```bash
go build ./...          # Build
go test ./...           # Run all tests
golangci-lint run       # Lint (non-blocking in CI)
go fmt ./...            # Format
```

CI runs tests across Go 1.21, 1.22, and 1.23. The module requires Go 1.22+.

## Architecture

The SDK is organized as a flat resource-based client:

```
imgsrc.go              → SDK entry point, New() constructor, option functions
├── images.go          → Images resource (Upload, List, Search, GetMetadata, Delete, CreateSignedURL, DeletePath)
├── presets.go         → Presets resource (ListPresets, CreatePreset, GetPreset, UpdatePreset, DeletePreset)
├── settings.go        → Settings resource (Get, Update)
└── usage.go           → Usage resource (Get)

models/
├── components/        → Shared request/response model structs (33 files)
├── operations/        → Per-operation request/response types + per-operation options
└── apierrors/         → Error types (APIError, ErrorResponse)

internal/
├── config/            → SDKConfiguration struct
├── hooks/             → Lifecycle hooks (SDKInit, BeforeRequest, AfterSuccess, AfterError)
└── utils/             → JSON marshal/unmarshal, security, retries, request body, query/path params, headers

types/                 → Pointer helper functions (String, Bool, Int, Int64, Float32, Float64, Pointer[T])
optionalnullable/      → Three-state type: set-to-value / set-to-null / unset
retry/                 → Retry configuration (BackoffStrategy)
```

### SDK initialization pattern

```go
s := sdkgo.New(
    sdkgo.WithSecurity("imgsrc_..."),
    sdkgo.WithServerURL("https://api.img-src.io"),
    sdkgo.WithTimeout(30 * time.Second),
)
// Access resources: s.Images, s.Settings, s.Presets, s.Usage
```

### Key patterns

- **Options pattern**: `SDKOption` functions on `New()`, per-operation `Option` functions (e.g., `WithRetries`, `WithOperationTimeout`)
- **Pagination**: Response objects have a `Next()` method; loop until `res == nil`
- **Error handling**: Operations return `(response, error)`. Use `errors.As(err, &e)` with `*apierrors.ErrorResponse` or `*apierrors.APIError`
- **Pointer helpers**: Use `sdkgo.Pointer[T](v)` or type-specific helpers (`sdkgo.String()`, `sdkgo.Int64()`) for optional parameters
- **OptionalNullable**: `optionalnullable.From(v)` for set, nil map for unset, `map[bool]*T{false: nil}` for explicit null
- **Custom JSON**: All models implement `MarshalJSON`/`UnmarshalJSON` via `internal/utils/json.go`. Struct tags: `json:`, `queryParam:`, `pathParam:`, `header:`, `default:`
- **Hooks**: Register custom lifecycle hooks in `internal/hooks/registration.go` (the only non-generated hooks file). Four events: SDKInit, BeforeRequest, AfterSuccess, AfterError

### Test files

Only two packages have tests:
- `internal/utils/union_test.go` — union type discrimination
- `optionalnullable/optionalnullable_test.go` — three-state type behavior

Tests use `github.com/stretchr/testify` (assert/require). Run a single test with `go test ./internal/utils/ -run TestPickBestUnionCandidate`.

## Code Generation

SDK is generated by Speakeasy from the OpenAPI spec at `api/openapi.json` (in the parent monorepo). Regeneration metadata is in `.speakeasy/gen.lock`. Do not manually edit generated files — changes will be lost. The only safe extension points are:
- `internal/hooks/registration.go` — custom hook implementations
- Non-tracked files not listed in `.speakeasy/gen.lock`
